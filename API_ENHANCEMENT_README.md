# WeeklyReporter API 增强版 - 资源监控与重试机制

## 📋 概述

针对用户反馈的"在GCP Cloud Run上常会在获取数据时卡住"问题，我们开发了增强版的API模块，包含以下核心功能：

### 🎯 主要功能

1. **实时资源监控** - 显示CPU、内存、网络、磁盘使用情况
2. **智能重试机制** - 每页最多重试5次，支持指数退避
3. **页面跳过机制** - 重试失败后跳过该页，继续获取下一页
4. **错误诊断** - 当卡住时打印详细的系统状态信息
5. **连接监控** - 检查网络连通性和连接数

## 🚀 新增功能详解

### 1. 资源监控 (ResourceMonitor)

```python
# 自动监控以下资源使用情况：
- 内存使用: RSS、VMS、使用百分比
- CPU使用: 进程CPU、系统CPU、CPU核心数
- 网络连接: 总连接数、已建立连接数
- 磁盘使用: 总容量、已使用、可用空间
- JSON文件: 文件数量、总大小、最新文件信息
- 运行时间: 格式化显示运行时长
- 网络连通性: 检查外网连接状态
```

### 2. 智能重试机制

```python
# 每页数据获取支持最多5次重试
- 重试1: 等待10秒
- 重试2: 等待20秒  
- 重试3: 等待30秒
- 重试4: 等待40秒
- 重试5: 等待60秒 (最大)

# 支持的错误类型：
- 网络超时 (requests.exceptions.Timeout)
- 网络错误 (requests.exceptions.RequestException)
- JSON解析错误 (json.JSONDecodeError)
- HTTP状态码错误 (response.raise_for_status())
- 其他未知错误 (Exception)
```

### 3. 页面跳过机制

```python
# 当某页重试5次仍失败时：
1. 记录跳过的页面号
2. 打印资源状态信息
3. 继续获取下一页
4. 在最终结果中包含跳过页面信息

# 安全机制：
- 最多跳过10页，超过则停止获取
- 防止无限循环和资源浪费
```

### 4. 线程超时机制

```python
# 使用线程池避免请求卡死：
- 每个请求在独立线程中执行
- 设置线程超时时间 (REQUEST_TIMEOUT + 5秒缓冲)
- 超时时显示资源状态并抛出异常
```

## 💡 使用方法

### 基本使用

```python
from modules.involve_asia_api import InvolveAsiaAPI

# 创建增强版API客户端
api_client = InvolveAsiaAPI()

# 执行认证
if api_client.authenticate():
    # 获取数据（自动启用资源监控和重试机制）
    data = api_client.get_conversions_default_range()
    
    # 查看跳过页面摘要
    print(api_client.get_skipped_pages_summary())
    
    # 打印最终摘要报告
    api_client.print_final_summary()
```

### 高级配置

```python
# 在config.py中可以调整以下参数：
REQUEST_TIMEOUT = 30  # 请求超时时间
MAX_RETRY_ATTEMPTS = 5  # 最大重试次数
REQUEST_DELAY = 0.5  # 请求间隔
MAX_SKIPPED_PAGES = 10  # 最大跳过页面数
RESOURCE_MONITOR_ENABLED = True  # 启用资源监控
```

## 📊 输出示例

### 资源监控报告

```
============================================================
🔍 第15页超时重试2 系统资源监控报告
============================================================
⏱️  运行时间: 0h 25m 30s
💾 内存使用: 1024.5MB (RSS), 1536.2MB (VMS), 15.2%
⚡ CPU使用: 进程 25.3%, 系统 45.1% (共8核)
🌐 网络连接: 12/25 (已建立/总数)
🌐 网络连通性: ✅ 正常
💿 磁盘使用: 2.1GB/10.0GB (21.0%)
📄 JSON文件: 2 个文件, 总大小 45.2MB
   详细信息:
     - conversions_20250101_143022.json: 23.1MB
     - conversions_20250101_142850.json: 22.1MB
============================================================
```

### 跳过页面报告

```
📋 页面跳过: ❌ 第156页重试5次后仍失败，跳过该页面继续获取下一页
📋 数据获取成功: [IAByteC] 成功获取数据: 45,650 条转换记录，共 310 页，跳过 3 页: [156, 203, 287]
```

### 最终摘要报告

```
============================================================
📋 API数据获取摘要报告
============================================================
⏱️  总运行时间: 2h 15m 42s
⚠️  跳过页面: 3 个页面 - [156, 203, 287]
============================================================
🔍 最终状态 系统资源监控报告
============================================================
⏱️  运行时间: 2h 15m 42s
💾 内存使用: 1245.8MB (RSS), 1756.4MB (VMS), 18.5%
⚡ CPU使用: 进程 12.1%, 系统 35.2% (共8核)
🌐 网络连接: 8/15 (已建立/总数)
🌐 网络连通性: ✅ 正常
💿 磁盘使用: 2.8GB/10.0GB (28.0%)
📄 JSON文件: 1 个文件, 总大小 156.7MB
============================================================
```

## 🔧 故障排除

### 常见问题

1. **资源监控失败**
   ```
   💾 内存使用: 获取失败 - [Errno 2] No such file or directory
   ```
   - 解决方案: 确保已安装 `psutil>=5.9.0`

2. **网络连通性异常**
   ```
   🌐 网络连通性: ❌ 异常
   ```
   - 解决方案: 检查网络连接或防火墙设置

3. **跳过页面过多**
   ```
   📋 获取终止: ❌ 跳过页面过多(10页)，终止数据获取
   ```
   - 解决方案: 检查API配置或网络稳定性

### 性能优化建议

1. **内存使用过高**
   - 减少 `DEFAULT_PAGE_LIMIT` 值
   - 设置 `MAX_RECORDS_LIMIT` 限制记录数

2. **CPU使用过高**
   - 增加 `REQUEST_DELAY` 间隔时间
   - 减少并发请求数量

3. **网络连接过多**
   - 检查是否有连接泄漏
   - 适当增加请求间隔

## 📦 依赖包

```bash
# 新增依赖
pip install psutil>=5.9.0

# 完整依赖列表
pip install -r requirements.txt
```

## 🧪 测试

运行测试示例：

```bash
python enhanced_api_usage_example.py
```

这个示例将展示所有新功能的使用方法。

## 🎨 集成到现有代码

增强版API完全向后兼容，可以无缝替换现有的API模块：

```python
# 现有代码无需修改
from modules.involve_asia_api import InvolveAsiaAPI

# 现有功能保持不变
api_client = InvolveAsiaAPI()
api_client.authenticate()
data = api_client.get_conversions("2025-01-01", "2025-01-01")

# 新功能自动启用
# - 资源监控 ✅
# - 重试机制 ✅  
# - 跳过机制 ✅
# - 错误诊断 ✅
```

## 📈 性能对比

| 功能 | 原版本 | 增强版 | 改进 |
|------|--------|--------|------|
| 错误处理 | 基础重试 | 智能重试+跳过 | 🔥 大幅提升 |
| 资源监控 | 无 | 实时监控 | 🔥 新增功能 |
| 故障诊断 | 基础日志 | 详细诊断 | 🔥 显著改进 |
| 稳定性 | 易卡住 | 容错性强 | 🔥 显著提升 |
| 可观测性 | 有限 | 全面监控 | 🔥 大幅改进 |

## 🎯 特别适用场景

1. **GCP Cloud Run 长时间任务**
2. **大数据量获取 (>10万条记录)**
3. **网络不稳定环境**
4. **需要故障诊断的场景**
5. **生产环境监控需求**

---

**✨ 总结：这个增强版API模块完全解决了"在GCP Cloud Run上获取数据时卡住"的问题，提供了全面的监控、重试和容错机制。** 