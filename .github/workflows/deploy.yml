name: Deploy WeeklyReporter to GCP Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_ID: solar-idea-463423-h8
  SERVICE_ACCOUNT: weeklyreporter@solar-idea-463423-h8.iam.gserviceaccount.com
  REGION: asia-east1
  SERVICE_NAME: weeklyreporter
  IMAGE: asia-east1-docker.pkg.dev/solar-idea-463423-h8/weeklyreporter/app

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8

    - name: Run code quality checks
      run: |
        echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        # æ£€æŸ¥ Python è¯­æ³•
        python -m py_compile main.py config.py
        python -m py_compile modules/*.py
        echo "âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡"

    - name: Run basic tests
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
        python -c "import main; print('âœ… Main module import successful')"
        python -c "import config; print('âœ… Config module import successful')"
        echo "âœ… åŸºç¡€æµ‹è¯•å®Œæˆ"

  # æ„å»ºå’Œéƒ¨ç½² (ä»…åœ¨ main åˆ†æ”¯)
  build-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Verify Configuration
      run: |
        echo "ğŸ” éªŒè¯å½“å‰é…ç½®:"
        echo "é¡¹ç›®: ${{ env.PROJECT_ID }}"
        echo "Service Account: ${{ env.SERVICE_ACCOUNT }}"
        echo "åŒºåŸŸ: ${{ env.REGION }}"
        echo "é•œåƒ: ${{ env.IMAGE }}"
        echo "SHA: ${{ github.sha }}"
        echo ""
        echo "ğŸ” å½“å‰è®¤è¯çŠ¶æ€:"
        gcloud auth list
        echo ""
        echo "ğŸ” å½“å‰é¡¹ç›®:"
        gcloud config get-value project

    - name: Configure Docker for Artifact Registry
      run: |
        echo "ğŸ”§ é…ç½® Docker è®¤è¯..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Create Artifact Registry repository (if needed)
      run: |
        echo "ğŸ“¦ åˆ›å»º Artifact Registry ä»“åº“..."
        gcloud artifacts repositories create weeklyreporter \
          --repository-format=docker \
          --location=${{ env.REGION }} \
          --description="WeeklyReporter Docker images" || echo "âœ… ä»“åº“å·²å­˜åœ¨"

    - name: Build Docker Image
      run: |
        echo "ğŸ—ï¸ æ„å»º Docker é•œåƒ..."
        IMAGE_TAG="${{ env.IMAGE }}:${{ github.sha }}"
        IMAGE_LATEST="${{ env.IMAGE }}:latest"
        
        docker build -f Dockerfile.cloudrun \
          -t $IMAGE_TAG \
          -t $IMAGE_LATEST \
          --build-arg GIT_SHA=${{ github.sha }} \
          .
        
        echo "âœ… é•œåƒæ„å»ºå®Œæˆ"
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV

    - name: Push Docker Image
      run: |
        echo "ğŸ“¤ æ¨é€é•œåƒåˆ° Artifact Registry..."
        docker push ${{ env.IMAGE_TAG }}
        docker push ${{ env.IMAGE_LATEST }}
        echo "âœ… é•œåƒæ¨é€å®Œæˆ"

    - name: Deploy to Cloud Run
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ° Cloud Run..."
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.IMAGE_TAG }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 1Gi \
          --cpu 1 \
          --timeout 3600 \
          --max-instances 3 \
          --min-instances 0 \
          --service-account ${{ env.SERVICE_ACCOUNT }} \
          --set-env-vars "TZ=Asia/Shanghai,GIT_SHA=${{ github.sha }},DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --tag sha-${SHORT_SHA} \
          --quiet
        echo "âœ… éƒ¨ç½²å®Œæˆ"

    - name: Get Service Info and Health Check
      run: |
        echo "ğŸ“Š è·å–æœåŠ¡ä¿¡æ¯..."
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        echo ""
        echo "ğŸ‰ éƒ¨ç½²ç»“æœ:"
        echo "ğŸ”— Service URL: $SERVICE_URL"
        echo "ğŸ·ï¸  Image Tag: ${{ env.IMAGE_TAG }}"
        echo "ğŸ”„ Git SHA: ${{ github.sha }}"
        
        # å¥åº·æ£€æŸ¥
        echo ""
        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        sleep 10  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        
        # æ£€æŸ¥æ ¹è·¯å¾„
        if curl -f -s "$SERVICE_URL/" > /dev/null; then
          echo "âœ… æ ¹è·¯å¾„å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ æ ¹è·¯å¾„å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        # æ£€æŸ¥çŠ¶æ€ç«¯ç‚¹
        if curl -f -s "$SERVICE_URL/status" > /dev/null; then
          echo "âœ… çŠ¶æ€ç«¯ç‚¹å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ çŠ¶æ€ç«¯ç‚¹å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        echo ""
        echo "ğŸ“ å¯ç”¨ç«¯ç‚¹:"
        echo "  - å¥åº·æ£€æŸ¥: curl $SERVICE_URL/"
        echo "  - çŠ¶æ€æ£€æŸ¥: curl $SERVICE_URL/status"
        echo "  - æ‰‹åŠ¨è§¦å‘: curl -X POST $SERVICE_URL/run"

    - name: Update Traffic to Latest
      run: |
        echo "ğŸš¦ æ›´æ–°æµé‡åˆ°æœ€æ–°ç‰ˆæœ¬..."
        gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
          --to-latest \
          --region ${{ env.REGION }} \
          --quiet
        echo "âœ… æµé‡æ›´æ–°å®Œæˆ"

    - name: Cleanup Old Revisions
      run: |
        echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
        # ä¿ç•™æœ€è¿‘çš„3ä¸ªç‰ˆæœ¬
        gcloud run revisions list \
          --service ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --limit 100 \
          --sort-by ~metadata.creationTimestamp \
          --format "value(metadata.name)" | tail -n +4 | while read revision; do
          if [ ! -z "$revision" ]; then
            echo "åˆ é™¤æ—§ç‰ˆæœ¬: $revision"
            gcloud run revisions delete $revision --region ${{ env.REGION }} --quiet || true
          fi
        done
        echo "âœ… æ¸…ç†å®Œæˆ"

  # PR é¢„è§ˆæ„å»º (ä»…æ„å»ºï¼Œä¸éƒ¨ç½²)
  preview-build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build Preview Image
      run: |
        echo "ğŸ—ï¸ æ„å»ºé¢„è§ˆé•œåƒ (PR #${{ github.event.number }})..."
        PREVIEW_TAG="${{ env.IMAGE }}:pr-${{ github.event.number }}-${{ github.sha }}"
        
        docker build -f Dockerfile.cloudrun \
          -t $PREVIEW_TAG \
          --build-arg GIT_SHA=${{ github.sha }} \
          .
        
        echo "âœ… é¢„è§ˆé•œåƒæ„å»ºå®Œæˆ: $PREVIEW_TAG"
        echo "â„¹ï¸  æ³¨æ„: é¢„è§ˆé•œåƒå·²æ„å»ºä½†æœªéƒ¨ç½²" 