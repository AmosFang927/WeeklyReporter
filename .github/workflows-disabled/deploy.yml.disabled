name: Deploy WeeklyReporter to GCP Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_ID: solar-idea-463423-h8
  SERVICE_ACCOUNT: weeklyreporter@solar-idea-463423-h8.iam.gserviceaccount.com
  REGION: asia-southeast1  # æ›´æ–°ä¸ºæ–°åŠ å¡åŒºåŸŸ
  SERVICE_NAME: weeklyreporter
  POSTBACK_SERVICE_NAME: bytec-public-postback
  IMAGE: asia-southeast1-docker.pkg.dev/solar-idea-463423-h8/weeklyreporter/app
  POSTBACK_IMAGE: asia-southeast1-docker.pkg.dev/solar-idea-463423-h8/weeklyreporter/postback

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r postback_system/requirements.txt
        pip install pytest flake8

    - name: Run code quality checks
      run: |
        echo "ğŸ” è¿è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        # æ£€æŸ¥ Python è¯­æ³•
        python -m py_compile main.py config.py
        python -m py_compile modules/*.py
        python -m py_compile postback_system/main.py postback_system/app/*.py
        echo "âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡"

    - name: Run basic tests
      run: |
        echo "ğŸ§ª è¿è¡ŒåŸºç¡€æµ‹è¯•..."
        python -c "import main; print('âœ… Main module import successful')"
        python -c "import config; print('âœ… Config module import successful')"
        cd postback_system && python -c "import main; print('âœ… Postback module import successful')"
        echo "âœ… åŸºç¡€æµ‹è¯•å®Œæˆ"

  # æ„å»ºå’Œéƒ¨ç½² WeeklyReporter ä¸»æœåŠ¡
  build-deploy-main:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Verify Configuration
      run: |
        echo "ğŸ” éªŒè¯å½“å‰é…ç½®:"
        echo "é¡¹ç›®: ${{ env.PROJECT_ID }}"
        echo "Service Account: ${{ env.SERVICE_ACCOUNT }}"
        echo "åŒºåŸŸ: ${{ env.REGION }}"
        echo "é•œåƒ: ${{ env.IMAGE }}"
        echo "SHA: ${{ github.sha }}"
        echo ""
        echo "ğŸ” å½“å‰è®¤è¯çŠ¶æ€:"
        gcloud auth list
        echo ""
        echo "ğŸ” å½“å‰é¡¹ç›®:"
        gcloud config get-value project

    - name: Configure Docker for Artifact Registry
      run: |
        echo "ğŸ”§ é…ç½® Docker è®¤è¯..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Create Artifact Registry repository (if needed)
      run: |
        echo "ğŸ“¦ åˆ›å»º Artifact Registry ä»“åº“..."
        gcloud artifacts repositories create weeklyreporter \
          --repository-format=docker \
          --location=${{ env.REGION }} \
          --description="WeeklyReporter Docker images" || echo "âœ… ä»“åº“å·²å­˜åœ¨"

    - name: Build Docker Image
      run: |
        echo "ğŸ—ï¸ æ„å»º WeeklyReporter Docker é•œåƒ..."
        IMAGE_TAG="${{ env.IMAGE }}:${{ github.sha }}"
        IMAGE_LATEST="${{ env.IMAGE }}:latest"
        
        docker build -f Dockerfile.cloudrun \
          -t $IMAGE_TAG \
          -t $IMAGE_LATEST \
          --build-arg GIT_SHA=${{ github.sha }} \
          .
        
        echo "âœ… é•œåƒæ„å»ºå®Œæˆ"
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        echo "IMAGE_LATEST=$IMAGE_LATEST" >> $GITHUB_ENV

    - name: Push Docker Image
      run: |
        echo "ğŸ“¤ æ¨é€é•œåƒåˆ° Artifact Registry..."
        docker push ${{ env.IMAGE_TAG }}
        docker push ${{ env.IMAGE_LATEST }}
        echo "âœ… é•œåƒæ¨é€å®Œæˆ"

    - name: Deploy to Cloud Run
      run: |
        echo "ğŸš€ éƒ¨ç½² WeeklyReporter åˆ° Cloud Run..."
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.IMAGE_TAG }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 32Gi \
          --cpu 8 \
          --timeout 3600 \
          --max-instances 3 \
          --min-instances 0 \
          --service-account ${{ env.SERVICE_ACCOUNT }} \
          --set-env-vars "TZ=Asia/Singapore,GIT_SHA=${{ github.sha }},DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --tag sha-${SHORT_SHA} \
          --quiet
        echo "âœ… WeeklyReporter éƒ¨ç½²å®Œæˆ"

    - name: Get Service Info and Health Check
      run: |
        echo "ğŸ“Š è·å–æœåŠ¡ä¿¡æ¯..."
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        echo ""
        echo "ğŸ‰ WeeklyReporter éƒ¨ç½²ç»“æœ:"
        echo "ğŸ”— Service URL: $SERVICE_URL"
        echo "ğŸ·ï¸  Image Tag: ${{ env.IMAGE_TAG }}"
        echo "ğŸ”„ Git SHA: ${{ github.sha }}"
        
        # å¥åº·æ£€æŸ¥
        echo ""
        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        sleep 10  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        
        # æ£€æŸ¥æ ¹è·¯å¾„
        if curl -f -s "$SERVICE_URL/" > /dev/null; then
          echo "âœ… æ ¹è·¯å¾„å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ æ ¹è·¯å¾„å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        # æ£€æŸ¥çŠ¶æ€ç«¯ç‚¹
        if curl -f -s "$SERVICE_URL/status" > /dev/null; then
          echo "âœ… çŠ¶æ€ç«¯ç‚¹å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ çŠ¶æ€ç«¯ç‚¹å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        echo ""
        echo "ğŸ“ WeeklyReporter å¯ç”¨ç«¯ç‚¹:"
        echo "  - å¥åº·æ£€æŸ¥: curl $SERVICE_URL/"
        echo "  - çŠ¶æ€æ£€æŸ¥: curl $SERVICE_URL/status"
        echo "  - æ‰‹åŠ¨è§¦å‘: curl -X POST $SERVICE_URL/run"

  # æ„å»ºå’Œéƒ¨ç½² Postback æœåŠ¡
  build-deploy-postback:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        echo "ğŸ”§ é…ç½® Docker è®¤è¯..."
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build Postback Docker Image
      run: |
        echo "ğŸ—ï¸ æ„å»º Postback Docker é•œåƒ..."
        POSTBACK_IMAGE_TAG="${{ env.POSTBACK_IMAGE }}:${{ github.sha }}"
        POSTBACK_IMAGE_LATEST="${{ env.POSTBACK_IMAGE }}:latest"
        
        docker build -f postback_system/Dockerfile.cloudrun \
          -t $POSTBACK_IMAGE_TAG \
          -t $POSTBACK_IMAGE_LATEST \
          --build-arg GIT_SHA=${{ github.sha }} \
          postback_system/
        
        echo "âœ… Postbacké•œåƒæ„å»ºå®Œæˆ"
        echo "POSTBACK_IMAGE_TAG=$POSTBACK_IMAGE_TAG" >> $GITHUB_ENV
        echo "POSTBACK_IMAGE_LATEST=$POSTBACK_IMAGE_LATEST" >> $GITHUB_ENV

    - name: Push Postback Docker Image
      run: |
        echo "ğŸ“¤ æ¨é€ Postback é•œåƒåˆ° Artifact Registry..."
        docker push ${{ env.POSTBACK_IMAGE_TAG }}
        docker push ${{ env.POSTBACK_IMAGE_LATEST }}
        echo "âœ… Postbacké•œåƒæ¨é€å®Œæˆ"

    - name: Deploy Postback to Cloud Run
      run: |
        echo "ğŸš€ éƒ¨ç½² Postback åˆ° Cloud Run..."
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        gcloud run deploy ${{ env.POSTBACK_SERVICE_NAME }} \
          --image ${{ env.POSTBACK_IMAGE_TAG }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 2Gi \
          --cpu 1 \
          --timeout 300 \
          --max-instances 5 \
          --min-instances 0 \
          --service-account ${{ env.SERVICE_ACCOUNT }} \
          --set-env-vars "TZ=Asia/Singapore,STORAGE_TYPE=memory,GIT_SHA=${{ github.sha }},DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
          --tag sha-${SHORT_SHA} \
          --quiet
        echo "âœ… Postback éƒ¨ç½²å®Œæˆ"

    - name: Get Postback Service Info and Health Check
      run: |
        echo "ğŸ“Š è·å– Postback æœåŠ¡ä¿¡æ¯..."
        POSTBACK_SERVICE_URL=$(gcloud run services describe ${{ env.POSTBACK_SERVICE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        echo ""
        echo "ğŸ‰ Postback éƒ¨ç½²ç»“æœ:"
        echo "ğŸ”— Service URL: $POSTBACK_SERVICE_URL"
        echo "ğŸ·ï¸  Image Tag: ${{ env.POSTBACK_IMAGE_TAG }}"
        echo "ğŸ”„ Git SHA: ${{ github.sha }}"
        
        # å¥åº·æ£€æŸ¥
        echo ""
        echo "ğŸ¥ æ‰§è¡Œ Postback å¥åº·æ£€æŸ¥..."
        sleep 10  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        
        # æ£€æŸ¥å¥åº·ç«¯ç‚¹
        if curl -f -s "$POSTBACK_SERVICE_URL/health" > /dev/null; then
          echo "âœ… Postback å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ Postback å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        echo ""
        echo "ğŸ“ Postback å¯ç”¨ç«¯ç‚¹:"
        echo "  - å¥åº·æ£€æŸ¥: curl $POSTBACK_SERVICE_URL/health"
        echo "  - æœåŠ¡ä¿¡æ¯: curl $POSTBACK_SERVICE_URL/"
        echo "  - Postbackæ¥æ”¶: curl \"$POSTBACK_SERVICE_URL/involve/event?sub_id=test&media_id=test&click_id=test&usd_sale_amount=10.00&usd_payout=1.00\""

  # æ›´æ–°æµé‡å’Œæ¸…ç†
  finalize-deployment:
    needs: [build-deploy-main, build-deploy-postback]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Update Traffic to Latest
      run: |
        echo "ğŸš¦ æ›´æ–°æµé‡åˆ°æœ€æ–°ç‰ˆæœ¬..."
        
        # æ›´æ–° WeeklyReporter æµé‡
        gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
          --to-latest \
          --region ${{ env.REGION }} \
          --quiet
        
        # æ›´æ–° Postback æµé‡
        gcloud run services update-traffic ${{ env.POSTBACK_SERVICE_NAME }} \
          --to-latest \
          --region ${{ env.REGION }} \
          --quiet
        
        echo "âœ… æµé‡æ›´æ–°å®Œæˆ"

    - name: Cleanup Old Revisions
      run: |
        echo "ğŸ§¹ æ¸…ç†æ—§ç‰ˆæœ¬..."
        
        # æ¸…ç† WeeklyReporter æ—§ç‰ˆæœ¬
        echo "æ¸…ç† WeeklyReporter æ—§ç‰ˆæœ¬..."
        gcloud run revisions list \
          --service ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --limit 100 \
          --sort-by ~metadata.creationTimestamp \
          --format "value(metadata.name)" | tail -n +4 | while read revision; do
          if [ ! -z "$revision" ]; then
            echo "åˆ é™¤æ—§ç‰ˆæœ¬: $revision"
            gcloud run revisions delete $revision --region ${{ env.REGION }} --quiet || true
          fi
        done
        
        # æ¸…ç† Postback æ—§ç‰ˆæœ¬
        echo "æ¸…ç† Postback æ—§ç‰ˆæœ¬..."
        gcloud run revisions list \
          --service ${{ env.POSTBACK_SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --limit 100 \
          --sort-by ~metadata.creationTimestamp \
          --format "value(metadata.name)" | tail -n +4 | while read revision; do
          if [ ! -z "$revision" ]; then
            echo "åˆ é™¤æ—§ç‰ˆæœ¬: $revision"
            gcloud run revisions delete $revision --region ${{ env.REGION }} --quiet || true
          fi
        done
        
        echo "âœ… æ¸…ç†å®Œæˆ"

    - name: Deployment Summary
      run: |
        echo ""
        echo "ğŸ‰ éƒ¨ç½²æ±‡æ€»:"
        echo "=========================================="
        
        # è·å–æœåŠ¡URLs
        MAIN_SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        POSTBACK_SERVICE_URL=$(gcloud run services describe ${{ env.POSTBACK_SERVICE_NAME }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --format 'value(status.url)')
        
        echo "ğŸ“Š WeeklyReporter æœåŠ¡:"
        echo "  ğŸ”— URL: $MAIN_SERVICE_URL"
        echo "  ğŸ“ åŒºåŸŸ: ${{ env.REGION }}"
        echo "  â° æ—¶åŒº: Asia/Singapore (GMT+8)"
        echo ""
        echo "ğŸ“Š Postback æœåŠ¡:"
        echo "  ğŸ”— URL: $POSTBACK_SERVICE_URL"
        echo "  ğŸ“ åŒºåŸŸ: ${{ env.REGION }}"
        echo "  â° æ—¶åŒº: Asia/Singapore (GMT+8)"
        echo ""
        echo "ğŸ”„ Git SHA: ${{ github.sha }}"
        echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo "=========================================="

  # PR é¢„è§ˆæ„å»º (ä»…æ„å»ºï¼Œä¸éƒ¨ç½²)
  preview-build:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        service_account: ${{ env.SERVICE_ACCOUNT }}

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    - name: Build Preview Images
      run: |
        echo "ğŸ—ï¸ æ„å»ºé¢„è§ˆé•œåƒ (PR #${{ github.event.number }})..."
        
        # æ„å»º WeeklyReporter é¢„è§ˆé•œåƒ
        PREVIEW_TAG="${{ env.IMAGE }}:pr-${{ github.event.number }}-${{ github.sha }}"
        docker build -f Dockerfile.cloudrun \
          -t $PREVIEW_TAG \
          --build-arg GIT_SHA=${{ github.sha }} \
          .
        
        # æ„å»º Postback é¢„è§ˆé•œåƒ
        POSTBACK_PREVIEW_TAG="${{ env.POSTBACK_IMAGE }}:pr-${{ github.event.number }}-${{ github.sha }}"
        docker build -f postback_system/Dockerfile.cloudrun \
          -t $POSTBACK_PREVIEW_TAG \
          --build-arg GIT_SHA=${{ github.sha }} \
          postback_system/
        
        echo "âœ… é¢„è§ˆé•œåƒæ„å»ºå®Œæˆ:"
        echo "  - WeeklyReporter: $PREVIEW_TAG"
        echo "  - Postback: $POSTBACK_PREVIEW_TAG"
        echo "â„¹ï¸  æ³¨æ„: é¢„è§ˆé•œåƒå·²æ„å»ºä½†æœªéƒ¨ç½²" 