# Postbackæ•°æ®å¤„ç†ç³»ç»Ÿ

ğŸ†• æ·»åŠ è‡ªç„¶è¯­è¨€æŸ¥è¯¢åŠŸèƒ½


åˆ›å»ºGCP Cloud SQL PostgreSQLå®ä¾‹ï¼Œé…ç½®ç½‘ç»œå’Œå®‰å…¨è®¾ç½®
ByteC2024PostBack_CloudSQL_20250708
å°†ç°æœ‰PostgreSQLæ•°æ®è¿ç§»åˆ°Cloud SQLå®ä¾‹
æ›´æ–°Cloud Runé…ç½®è¿æ¥Cloud SQLï¼Œé…ç½®VPCè¿æ¥å™¨
éƒ¨ç½²æ›´æ–°åçš„postbackæœåŠ¡åˆ°bytec-public-postback

é…ç½®Looker Studioè¿æ¥Cloud SQLï¼Œåˆ›å»ºæ•°æ®å¯è§†åŒ–ä»ªè¡¨æ¿
ä½¿ç”¨AppSheetåˆ›å»ºPartneré…ç½®ç®¡ç†ç•Œé¢
é…ç½®BigQueryæ•°æ®åŒæ­¥å’ŒVertex AIè‡ªç„¶è¯­è¨€æŸ¥è¯¢åŠŸèƒ½
ç«¯åˆ°ç«¯æµ‹è¯•æ•´ä¸ªGCPåŸç”Ÿç³»ç»Ÿ

## ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå®æ—¶æ¥æ”¶å’Œå¤„ç†ç”µå•†è½¬åŒ–å›ä¼ æ•°æ®çš„ç³»ç»Ÿï¼Œä¸“ä¸ºShopeeã€TikTok Shopç­‰ç”µå•†å¹³å°è®¾è®¡ï¼Œæ”¯æŒInvolve Asiaçš„Postbackæ ‡å‡†ã€‚

## ä¸»è¦åŠŸèƒ½

- âœ… **å®æ—¶Postbackæ¥æ”¶**: æ”¯æŒGET/POSTæ–¹å¼æ¥æ”¶è½¬åŒ–æ•°æ®
- âœ… **å¤šç§Ÿæˆ·ç®¡ç†**: åŸºäºTS Tokenã€TLM Tokenã€TS Parameterçš„ç§Ÿæˆ·è¯†åˆ«
- âœ… **æ•°æ®éªŒè¯ä¸æ¸…æ´—**: è‡ªåŠ¨éªŒè¯å’Œæ¸…æ´—è½¬åŒ–æ•°æ®
- âœ… **é‡å¤æ£€æµ‹**: é¿å…é‡å¤æ•°æ®çš„å½±å“
- âœ… **PostgreSQLå­˜å‚¨**: é«˜æ€§èƒ½æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢
- âœ… **REST API**: å®Œæ•´çš„æ•°æ®æŸ¥è¯¢å’Œç®¡ç†æ¥å£
- â­ **æ‰©å±•æ€§**: é¢„ç•™ML/AIæ¥å£ï¼Œæ”¯æŒæœªæ¥æ™ºèƒ½åˆ†æ

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Postbackæ•°æ®å¤„ç†ç³»ç»Ÿ                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¥ æ¥æ”¶å±‚ (FastAPI)                                         â”‚
â”‚  â”œâ”€â”€ GET /postback/ (URLå‚æ•°æ¥æ”¶)                            â”‚
â”‚  â”œâ”€â”€ POST /postback/ (JSONæ•°æ®æ¥æ”¶)                          â”‚
â”‚  â”œâ”€â”€ TokenéªŒè¯ä¸­é—´ä»¶                                         â”‚
â”‚  â””â”€â”€ ç§Ÿæˆ·è¯†åˆ«ä¸è·¯ç”±                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ—„ï¸ æ•°æ®å±‚ (PostgreSQL)                                      â”‚
â”‚  â”œâ”€â”€ è½¬åŒ–æ•°æ®å­˜å‚¨                                             â”‚
â”‚  â”œâ”€â”€ ç§Ÿæˆ·é…ç½®ç®¡ç†                                             â”‚
â”‚  â”œâ”€â”€ æ•°æ®æ¸…æ´—ä¸éªŒè¯                                           â”‚
â”‚  â””â”€â”€ è‡ªåŠ¨è¿‡æœŸæ¸…ç†                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”Œ æœåŠ¡å±‚                                                   â”‚
â”‚  â”œâ”€â”€ RESTful API                                            â”‚
â”‚  â”œâ”€â”€ æ•°æ®æŸ¥è¯¢ä¸ç»Ÿè®¡                                           â”‚
â”‚  â”œâ”€â”€ å¼‚å¸¸æ£€æµ‹                                                â”‚
â”‚  â””â”€â”€ MLç‰¹å¾å·¥ç¨‹ (é¢„ç•™)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£…ä¾èµ–
cd postback_system
pip install -r requirements.txt

# è®¾ç½®ç¯å¢ƒå˜é‡
export DATABASE_URL="postgresql+asyncpg://postback:postback123@localhost:5432/postback_db"
export DEBUG=true
```

### 2. æ•°æ®åº“è®¾ç½®

```bash
# å®‰è£…PostgreSQL (macOS)
brew install postgresql
brew services start postgresql

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
createdb postback_db
psql postback_db -c "CREATE USER postback WITH PASSWORD 'postback123';"
psql postback_db -c "GRANT ALL PRIVILEGES ON DATABASE postback_db TO postback;"
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼å¯åŠ¨
python main.py

# ç”Ÿäº§æ¨¡å¼å¯åŠ¨
uvicorn main:app --host 0.0.0.0 --port 8000
```

æœåŠ¡å¯åŠ¨åè®¿é—®ï¼š
- ğŸ  ä¸»é¡µ: http://localhost:8000
- ğŸ“– APIæ–‡æ¡£: http://localhost:8000/docs
- ğŸ’š å¥åº·æ£€æŸ¥: http://localhost:8000/health

## APIä½¿ç”¨ç¤ºä¾‹

### Postbackæ•°æ®æ¥æ”¶

#### GETæ–¹å¼ (æ ‡å‡†Involve Asiaæ ¼å¼)

```bash
curl "http://localhost:8000/postback/?conversion_id=12345&offer_id=100&usd_sale_amount=50.00&usd_payout=5.00&ts_token=your-token"
```

#### POSTæ–¹å¼ (JSONæ ¼å¼)

```bash
curl -X POST "http://localhost:8000/postback/?ts_token=your-token" \
     -H "Content-Type: application/json" \
     -d '{
       "conversion_id": "12345",
       "offer_id": "100",
       "usd_sale_amount": 50.00,
       "usd_payout": 5.00,
       "status": "Approved"
     }'
```

### æ•°æ®æŸ¥è¯¢

```bash
# æŸ¥è¯¢è½¬æ¢æ•°æ®
curl "http://localhost:8000/postback/conversions?page=1&page_size=10"

# è·å–ç»Ÿè®¡ä¿¡æ¯
curl "http://localhost:8000/postback/stats?hours=24"
```

## æ”¯æŒçš„Postbackå‚æ•°

### æ ¸å¿ƒå‚æ•°
- `conversion_id`: è½¬æ¢å”¯ä¸€ID **(å¿…å¡«)**
- `offer_id`: Offer ID
- `offer_name`: å¹¿å‘Šä¸»åç§°
- `datetime_conversion`: è½¬æ¢æ—¶é—´ (YYYY-MM-DD HH:MM:SS)
- `order_id`: è®¢å•ID

### é‡‘é¢å‚æ•°
- `sale_amount_local`: æœ¬åœ°è´§å¸é‡‘é¢
- `myr_sale_amount`: é©¬æ¥è¥¿äºšæ—å‰ç‰¹é‡‘é¢
- `usd_sale_amount`: ç¾å…ƒé‡‘é¢
- `payout_local`: æœ¬åœ°è´§å¸ä½£é‡‘
- `myr_payout`: é©¬æ¥è¥¿äºšæ—å‰ç‰¹ä½£é‡‘
- `usd_payout`: ç¾å…ƒä½£é‡‘
- `conversion_currency`: è´§å¸ä»£ç  (ISO 4217)

### è‡ªå®šä¹‰å‚æ•°
- `adv_sub` ~ `adv_sub5`: å¹¿å‘Šä¸»è‡ªå®šä¹‰å‚æ•°
- `aff_sub` ~ `aff_sub4`: å‘å¸ƒå•†è‡ªå®šä¹‰å‚æ•°

### Tokenå‚æ•°
- `ts_token`: TS Token (ç§Ÿæˆ·è¯†åˆ«)
- `ts_param`: TS Parameter (ç§Ÿæˆ·è¯†åˆ«)
- `tlm_token`: TLM Token (ç§Ÿæˆ·è¯†åˆ«)

## å¤šç§Ÿæˆ·é…ç½®

ç³»ç»Ÿæ”¯æŒå¤šç§Ÿæˆ·æ¨¡å¼ï¼Œæ¯ä¸ªç§Ÿæˆ·å¯ä»¥æœ‰ç‹¬ç«‹çš„ï¼š
- Tokené…ç½®
- æ•°æ®ä¿ç•™ç­–ç•¥
- é‡å¤æ£€æµ‹è§„åˆ™
- è¯·æ±‚é™åˆ¶

### ç§Ÿæˆ·è¯†åˆ«ä¼˜å…ˆçº§
1. `ts_token` åŒ¹é…
2. `ts_param` åŒ¹é…  
3. `tlm_token` åŒ¹é…
4. ä½¿ç”¨é»˜è®¤ç§Ÿæˆ·

## æ•°æ®ç®¡ç†

### è‡ªåŠ¨æ¸…ç†
- æ”¯æŒæŒ‰ç§Ÿæˆ·é…ç½®çš„æ•°æ®ä¿ç•™å¤©æ•°è‡ªåŠ¨æ¸…ç†
- é»˜è®¤ä¿ç•™7å¤©æ•°æ®
- å¯é€šè¿‡ç§Ÿæˆ·é…ç½®è‡ªå®šä¹‰ä¿ç•™ç­–ç•¥

### é‡å¤æ£€æµ‹
- åŸºäº `tenant_id` + `conversion_id` æ£€æµ‹é‡å¤
- å¯æŒ‰ç§Ÿæˆ·é…ç½®å¯ç”¨/ç¦ç”¨
- é‡å¤æ•°æ®ä¼šè¢«æ ‡è®°ä½†ä¸ä¼šä¸¢å¼ƒ

## ç›‘æ§ä¸æ—¥å¿—

### å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8000/health
```

### ç³»ç»Ÿä¿¡æ¯
```bash
curl http://localhost:8000/info
```

### æ—¥å¿—ç­‰çº§
- æ”¯æŒ DEBUG, INFO, WARNING, ERROR ç­‰çº§
- ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ INFO ç­‰çº§

## æ‰©å±•åŠŸèƒ½ (Phase 3&4 é¢„ç•™)

ç³»ç»Ÿå·²é¢„ç•™ä»¥ä¸‹æ‰©å±•æ¥å£ï¼š

### 1. æœºå™¨å­¦ä¹ é›†æˆ
- ç‰¹å¾å·¥ç¨‹æ¥å£
- æ¨¡å‹è®­ç»ƒæ•°æ®å¯¼å‡º
- é¢„æµ‹ç»“æœé›†æˆ

### 2. æ™ºèƒ½åˆ†æ
- å¼‚å¸¸æ£€æµ‹ç®—æ³•
- è½¬åŒ–ç‡é¢„æµ‹
- ç”¨æˆ·è¡Œä¸ºåˆ†æ

### 3. å¯è§†åŒ–Dashboard
- å®æ—¶æ•°æ®ç›‘æ§
- ç»Ÿè®¡å›¾è¡¨
- è‡ªå®šä¹‰æŠ¥è¡¨

## éƒ¨ç½²å»ºè®®

### æœ¬åœ°å¼€å‘
```bash
python main.py
```

### ç”Ÿäº§éƒ¨ç½²
```bash
# Dockeræ–¹å¼
docker build -t postback-system .
docker run -p 8000:8000 postback-system

# ç›´æ¥éƒ¨ç½²
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

### Google Cloudéƒ¨ç½²
```bash
# ä½¿ç”¨Cloud Run
gcloud run deploy postback-system --source . --platform managed
```

## æ€§èƒ½æŒ‡æ ‡

- ğŸ“Š **å¤„ç†èƒ½åŠ›**: æ¯æ—¥10ä¸‡+ è½¬åŒ–æ•°æ®
- âš¡ **å“åº”æ—¶é—´**: < 100ms (P95)
- ğŸ’¾ **å­˜å‚¨**: PostgreSQL + è‡ªåŠ¨æ¸…ç†
- ğŸ”„ **å¯ç”¨æ€§**: 99.9%+ (ç”Ÿäº§ç¯å¢ƒ)

## æŠ€æœ¯æ ˆ

- **åç«¯**: FastAPI + Python 3.8+
- **æ•°æ®åº“**: PostgreSQL + SQLAlchemy
- **ç¼“å­˜**: Redis (å¯é€‰)
- **ç›‘æ§**: å†…ç½®å¥åº·æ£€æŸ¥
- **éƒ¨ç½²**: Docker + Uvicorn

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“é…ç½®
   echo $DATABASE_URL
   # æµ‹è¯•è¿æ¥
   psql $DATABASE_URL -c "SELECT 1"
   ```

2. **TokenéªŒè¯å¤±è´¥**
   - æ£€æŸ¥ç§Ÿæˆ·é…ç½®
   - ç¡®è®¤Tokenæ ¼å¼æ­£ç¡®
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—

3. **æ€§èƒ½é—®é¢˜**
   - æ£€æŸ¥æ•°æ®åº“ç´¢å¼•
   - è°ƒæ•´è¿æ¥æ± å¤§å°
   - å¢åŠ workeræ•°é‡

## è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜è¯·æŸ¥çœ‹ï¼š
- ğŸ“– APIæ–‡æ¡£: `/docs`
- ğŸ“‹ å¥åº·çŠ¶æ€: `/health`
- ğŸ“Š ç³»ç»Ÿä¿¡æ¯: `/info` 