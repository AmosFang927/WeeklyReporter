# å¤šPartner Postbackç³»çµ±

## æ¦‚è¿°

å¤šPartner Postbackç³»çµ±æ˜¯ä¸€å€‹æ”¯æŒå¤šå€‹ä¸åŒPartnerçš„å‹•æ…‹postbackè™•ç†ç³»çµ±ã€‚æ¯å€‹Partneréƒ½æœ‰ç¨ç«‹çš„endpointã€æ•¸æ“šåº«å’ŒCloud Runæœå‹™ã€‚

## ç³»çµ±æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤šPartner Postbackç³»çµ±                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚   InvolveAsia   â”‚    â”‚     Rector      â”‚                â”‚
â”‚  â”‚   Partner       â”‚    â”‚    Partner      â”‚                â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                â”‚
â”‚  â”‚ Endpoint:       â”‚    â”‚ Endpoint:       â”‚                â”‚
â”‚  â”‚ /involve/event  â”‚    â”‚ /rector/event   â”‚                â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                â”‚
â”‚  â”‚ Cloud Run:      â”‚    â”‚ Cloud Run:      â”‚                â”‚
â”‚  â”‚ involve-service â”‚    â”‚ rector-service  â”‚                â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                â”‚
â”‚  â”‚ Database:       â”‚    â”‚ Database:       â”‚                â”‚
â”‚  â”‚ involve_asia_db â”‚    â”‚ rector_db       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½ç‰¹æ€§

### ğŸ”„ å‹•æ…‹Endpointè·¯ç”±
- æ ¹æ“šURLè·¯å¾‘è‡ªå‹•è­˜åˆ¥Partner
- æ”¯æŒç„¡é™æ“´å±•çš„Partneræ•¸é‡
- æ¯å€‹Partneræœ‰ç¨ç«‹çš„endpointé…ç½®

### ğŸ—„ï¸ æ•¸æ“šåº«åˆ†é›¢
- æ¯å€‹Partnerä½¿ç”¨ç¨ç«‹çš„æ•¸æ“šåº«
- æ•¸æ“šå®Œå…¨éš”é›¢ï¼Œç¢ºä¿å®‰å…¨æ€§
- æ”¯æŒä¸åŒçš„æ•¸æ“šåº«é¡å‹

### â˜ï¸ ç¨ç«‹Cloud Runæœå‹™
- æ¯å€‹Partneréƒ¨ç½²ç¨ç«‹çš„Cloud Runæœå‹™
- ç¨ç«‹çš„æ“´å±•å’Œç›£æ§
- ç¨ç«‹çš„è³‡æºé…ç½®

### ğŸ“Š åƒæ•¸æ˜ å°„
- æ”¯æŒä¸åŒPartnerçš„åƒæ•¸æ ¼å¼
- è‡ªå‹•åƒæ•¸æ˜ å°„å’Œè½‰æ›
- éˆæ´»çš„é…ç½®ç®¡ç†

### ğŸ” é‡è¤‡æª¢æ¸¬
- åŸºæ–¼conversion_idçš„é‡è¤‡æª¢æ¸¬
- é˜²æ­¢é‡è¤‡æ•¸æ“šè™•ç†
- å¯é…ç½®çš„æª¢æ¸¬ç­–ç•¥

### ğŸ“ è©³ç´°æ—¥èªŒ
- é—œéµæ­¥é©Ÿçš„è©³ç´°æ—¥èªŒè¨˜éŒ„
- è™•ç†æ™‚é–“çµ±è¨ˆ
- éŒ¯èª¤è¿½è¹¤å’Œèª¿è©¦

## Partneré…ç½®

### InvolveAsia Partner
```python
{
    "partner_code": "involve_asia",
    "partner_name": "InvolveAsia",
    "endpoint_path": "/involve/event",
    "cloud_run_service_name": "bytec-public-postback",
    "database_name": "involve_asia_db",
    "parameter_mapping": {
        "sub_id": "aff_sub",
        "media_id": "aff_sub2",
        "click_id": "aff_sub3",
        "usd_sale_amount": "usd_sale_amount",
        "usd_payout": "usd_payout",
        "offer_name": "offer_name",
        "conversion_id": "conversion_id",
        "conversion_datetime": "datetime_conversion"
    }
}
```

### Rector Partner
```python
{
    "partner_code": "rector",
    "partner_name": "Rector",
    "endpoint_path": "/rector/event",
    "cloud_run_service_name": "rector-postback",
    "database_name": "rector_db",
    "parameter_mapping": {
        "media_id": "media_id",
        "sub_id": "sub_id",
        "usd_sale_amount": "usd_sale_amount",
        "usd_earning": "usd_earning",
        "offer_name": "offer_name",
        "conversion_id": "conversion_id",
        "conversion_datetime": "conversion_datetime",
        "click_id": "click_id"
    }
}
```

## APIç«¯é»

### å‹•æ…‹Partnerç«¯é»
```
GET /partner/{endpoint_path}
POST /partner/{endpoint_path}
```

### çµ±è¨ˆç«¯é»
```
GET /partner/{endpoint_path}/stats
```

### è½‰åŒ–è¨˜éŒ„ç«¯é»
```
GET /partner/{endpoint_path}/conversions
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. InvolveAsia Postback
```bash
curl "http://localhost:8000/partner/involve/event?sub_id=test123&media_id=media456&click_id=click789&usd_sale_amount=99.99&usd_payout=9.99&offer_name=Test&conversion_id=conv001&conversion_datetime=2025-01-15"
```

### 2. Rector Postback
```bash
curl "http://localhost:8000/partner/rector/event?media_id=media456&sub_id=test123&usd_sale_amount=99.99&usd_earning=9.99&offer_name=Test&conversion_id=conv002&conversion_datetime=2025-01-15&click_id=click789"
```

### 3. ç²å–çµ±è¨ˆä¿¡æ¯
```bash
curl "http://localhost:8000/partner/involve/event/stats"
```

### 4. ç²å–è½‰åŒ–è¨˜éŒ„
```bash
curl "http://localhost:8000/partner/involve/event/conversions?limit=10"
```

## éƒ¨ç½²æµç¨‹

### 1. åˆå§‹åŒ–Partneré…ç½®
```bash
cd postback_system
python scripts/init_partners.py init
```

### 2. æœ¬åœ°æ¸¬è©¦
```bash
# å•Ÿå‹•æœå‹™
python main.py

# é‹è¡Œæ¸¬è©¦
python test_multi_partner.py
```

### 3. éƒ¨ç½²åˆ°Cloud Run
```bash
# éƒ¨ç½²æ‰€æœ‰Partner
bash deploy_multi_partner.sh
```

## é—œéµæ­¥é©Ÿæ—¥èªŒ

ç³»çµ±æœƒåœ¨è™•ç†éç¨‹ä¸­è¼¸å‡ºè©³ç´°çš„æ—¥èªŒä¿¡æ¯ï¼š

```
ğŸš€ é–‹å§‹è™•ç†å‹•æ…‹Partner Postback: endpoint_path=involve/event
ğŸ” æ­¥é©Ÿ1: æŸ¥æ‰¾Partneré…ç½®
âœ… æ‰¾åˆ°Partner: InvolveAsia (code: involve_asia)
ğŸ“Š æ­¥é©Ÿ2: æ”¶é›†åŸå§‹æ•¸æ“š
ğŸ“‹ åŸå§‹åƒæ•¸: {'sub_id': 'test123', 'media_id': 'media456', ...}
ğŸ”„ æ­¥é©Ÿ3: åƒæ•¸æ˜ å°„è™•ç†
  æ˜ å°„: sub_id -> aff_sub = test123
  æ˜ å°„: media_id -> aff_sub2 = media456
  æ˜ å°„: click_id -> aff_sub3 = click789
ğŸ” æ­¥é©Ÿ4: æª¢æŸ¥é‡è¤‡è½‰åŒ–
ğŸ’¾ æ­¥é©Ÿ5: å‰µå»ºè½‰åŒ–è¨˜éŒ„
âœ… æ­¥é©Ÿ6: æ¨™è¨˜ç‚ºå·²è™•ç†
ğŸ‰ Partner Postbackè™•ç†å®Œæˆ: partner=InvolveAsia, conversion_id=conv001, time=45.23ms
```

## æ•¸æ“šåº«çµæ§‹

### Partnerè¡¨
```sql
CREATE TABLE partners (
    id SERIAL PRIMARY KEY,
    partner_code VARCHAR(50) UNIQUE NOT NULL,
    partner_name VARCHAR(100) NOT NULL,
    endpoint_path VARCHAR(100) UNIQUE NOT NULL,
    endpoint_url VARCHAR(500),
    cloud_run_service_name VARCHAR(100),
    cloud_run_region VARCHAR(50) DEFAULT 'asia-southeast1',
    cloud_run_project_id VARCHAR(100),
    database_name VARCHAR(100),
    database_url VARCHAR(500),
    parameter_mapping JSON,
    is_active BOOLEAN DEFAULT TRUE,
    enable_logging BOOLEAN DEFAULT TRUE,
    max_daily_requests INTEGER DEFAULT 100000,
    data_retention_days INTEGER DEFAULT 30,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### PartnerConversionè¡¨
```sql
CREATE TABLE partner_conversions (
    id SERIAL PRIMARY KEY,
    partner_id INTEGER REFERENCES partners(id),
    conversion_id VARCHAR(50) NOT NULL,
    offer_id VARCHAR(50),
    offer_name TEXT,
    conversion_datetime TIMESTAMP WITH TIME ZONE,
    usd_sale_amount NUMERIC(15,2),
    usd_earning NUMERIC(15,2),
    media_id VARCHAR(255),
    sub_id VARCHAR(255),
    click_id VARCHAR(255),
    is_processed BOOLEAN DEFAULT FALSE,
    is_duplicate BOOLEAN DEFAULT FALSE,
    processing_error TEXT,
    raw_data JSON,
    request_headers JSON,
    request_ip VARCHAR(45),
    received_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## ç›£æ§å’Œç¶­è­·

### å¥åº·æª¢æŸ¥
```bash
curl "http://localhost:8000/health"
```

### ç³»çµ±ä¿¡æ¯
```bash
curl "http://localhost:8000/info"
```

### æŸ¥çœ‹æ—¥èªŒ
```bash
# æœ¬åœ°æ—¥èªŒ
tail -f logs/postback.log

# Cloud Runæ—¥èªŒ
gcloud logging read 'resource.type=cloud_run_revision' --limit=50
```

## æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **Partneræœªæ‰¾åˆ°**
   - æª¢æŸ¥Partneré…ç½®æ˜¯å¦æ­£ç¢º
   - ç¢ºèªendpoint_pathæ˜¯å¦åŒ¹é…

2. **æ•¸æ“šåº«é€£æ¥å¤±æ•—**
   - æª¢æŸ¥æ•¸æ“šåº«URLé…ç½®
   - ç¢ºèªæ•¸æ“šåº«æœå‹™æ˜¯å¦é‹è¡Œ

3. **åƒæ•¸æ˜ å°„éŒ¯èª¤**
   - æª¢æŸ¥parameter_mappingé…ç½®
   - ç¢ºèªåŸå§‹åƒæ•¸æ ¼å¼

4. **é‡è¤‡è½‰åŒ–æª¢æ¸¬å¤±æ•ˆ**
   - æª¢æŸ¥conversion_idæ˜¯å¦æ­£ç¢ºå‚³é
   - ç¢ºèªæ•¸æ“šåº«ç´¢å¼•æ˜¯å¦æ­£ç¢º

### èª¿è©¦æ¨¡å¼
```bash
# å•Ÿç”¨è©³ç´°æ—¥èªŒ
export LOG_LEVEL=DEBUG
python main.py
```

## æ“´å±•æŒ‡å—

### æ·»åŠ æ–°Partner

1. **å‰µå»ºPartneré…ç½®**
```python
new_partner = Partner(
    partner_code="new_partner",
    partner_name="New Partner",
    endpoint_path="/new/event",
    cloud_run_service_name="new-partner-service",
    database_name="new_partner_db",
    parameter_mapping={
        "param1": "mapped_param1",
        "param2": "mapped_param2"
    }
)
```

2. **éƒ¨ç½²æ–°æœå‹™**
```bash
bash deploy_multi_partner.sh new_partner
```

3. **æ¸¬è©¦æ–°ç«¯é»**
```bash
curl "http://localhost:8000/partner/new/event?param1=value1&param2=value2"
```

## æ€§èƒ½å„ªåŒ–

### æ•¸æ“šåº«å„ªåŒ–
- ä½¿ç”¨é©ç•¶çš„ç´¢å¼•
- å®šæœŸæ¸…ç†èˆŠæ•¸æ“š
- ä½¿ç”¨é€£æ¥æ± 

### ç·©å­˜ç­–ç•¥
- Redisç·©å­˜ç†±é–€æ•¸æ“š
- å…§å­˜ç·©å­˜Partneré…ç½®
- CDNç·©å­˜éœæ…‹è³‡æº

### ç›£æ§æŒ‡æ¨™
- è«‹æ±‚éŸ¿æ‡‰æ™‚é–“
- éŒ¯èª¤ç‡
- æ•¸æ“šåº«é€£æ¥æ•¸
- å…§å­˜ä½¿ç”¨ç‡

## å®‰å…¨è€ƒæ…®

### èªè­‰å’Œæˆæ¬Š
- APIå¯†é‘°é©—è­‰
- IPç™½åå–®
- è«‹æ±‚é »ç‡é™åˆ¶

### æ•¸æ“šå®‰å…¨
- æ•¸æ“šåŠ å¯†å‚³è¼¸
- æ•æ„Ÿæ•¸æ“šè„«æ•
- å®šæœŸå‚™ä»½

### å¯©è¨ˆæ—¥èªŒ
- è¨˜éŒ„æ‰€æœ‰æ“ä½œ
- ç•°å¸¸è¡Œç‚ºæª¢æ¸¬
- åˆè¦æ€§å ±å‘Š

## ç‰ˆæœ¬æ­·å²

### v1.0.0 (2025-01-15)
- åˆå§‹ç‰ˆæœ¬
- æ”¯æŒInvolveAsiaå’ŒRector Partner
- åŸºæœ¬çš„å¤šPartneræ¶æ§‹
- å‹•æ…‹endpointè·¯ç”±
- æ•¸æ“šåº«åˆ†é›¢

## è²¢ç»æŒ‡å—

1. Forké …ç›®
2. å‰µå»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. ç™¼èµ·Pull Request

## æˆæ¬Š

æœ¬é …ç›®æ¡ç”¨MITæˆæ¬Šæ¢æ¬¾ã€‚ 